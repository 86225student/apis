Option Explicit

Dim outputText As String
Dim indentLevel As Long

Sub AnalizujKomorke()
    Dim startCell As Range
    Dim filePath As String
    Dim fnum As Integer
    
    ' ðŸ”¹ Ustaw punkt startowy analizy
    Set startCell = ThisWorkbook.Sheets("wynik").Range("E7")
    
    ' ðŸ”¹ Reset zmiennych globalnych
    outputText = ""
    indentLevel = 0
    
    ' ðŸ”¹ Uruchom rekurencjÄ™
    Call SprawdzFormule(startCell)
    
    ' ðŸ”¹ Zapisz wynik do pliku tekstowego w katalogu pliku Excela
    filePath = ThisWorkbook.Path & "\analiza_drzewo.txt"
    fnum = FreeFile
    Open filePath For Output As #fnum
    Print #fnum, outputText
    Close #fnum
    
    MsgBox "Gotowe! Wynik zapisano w: " & filePath
End Sub

Private Sub SprawdzFormule(cel As Range)
    Dim f As String
    Dim dep As Range
    
    On Error Resume Next
    f = cel.Formula
    
    ' ðŸ”¹ Dopisz nazwÄ™ komÃ³rki z wciÄ™ciem
    outputText = outputText & String(indentLevel * 4, " ") & _
                 cel.Worksheet.Name & "!" & cel.Address(False, False)
    
    If f = "" Or Left(f, 1) <> "=" Then
        ' ðŸ”¹ KomÃ³rka bez formuÅ‚y â€“ pokaÅ¼ jej wartoÅ›Ä‡
        outputText = outputText & " = [" & cel.Value & "]" & vbCrLf
        Exit Sub
    Else
        outputText = outputText & " = " & f & vbCrLf
    End If
    
    ' ðŸ”¹ WejdÅº gÅ‚Ä™biej w precedensy (komÃ³rki ÅºrÃ³dÅ‚owe)
    indentLevel = indentLevel + 1
    On Error Resume Next
    For Each dep In cel.Precedents
        If Not dep Is Nothing Then
            Call SprawdzFormule(dep)
        End If
    Next dep
    indentLevel = indentLevel - 1
End Sub
